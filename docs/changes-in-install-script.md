# Изменения в скрипте install.sh для корректного переключения на обычного пользователя

## Проблема

При запуске команды `sudo ./install.sh all` скрипт корректно устанавливал системные пакеты, но при попытке установки пакетов из AUR (Arch User Repository) возникала проблема: скрипт не мог получить доступ к файлам проекта после переключения на обычного пользователя.

## Причина проблемы

1. При переключении на обычного пользователя с помощью `sudo -u` или `exec su`, переменная окружения `PROJECT_ROOT` не передавалась в новый контекст.
2. Функции `install_from_file` и `install_from_file_content` использовали относительные пути к файлам, которые не были доступны в контексте обычного пользователя.
3. В некоторых местах использовалась только команда `logname` без резервного варианта `whoami`.

## Внесенные изменения

### 1. Определение PROJECT_ROOT

- В начале скрипта добавлено определение переменной `PROJECT_ROOT` для хранения абсолютного пути к корню проекта
- В функциях, которые могут быть вызваны от обычного пользователя, добавлена проверка и восстановление переменной `PROJECT_ROOT`, если она не установлена

### 2. Корректное определение абсолютного пути к скрипту

- Ранее `SCRIPT_ABSOLUTE_PATH` определялся с помощью `$(cd "$(dirname "$0")" && pwd)/$(basename "$0")`, что приводило к неправильному пути при переключении на обычного пользователя
- Теперь `SCRIPT_ABSOLUTE_PATH` определяется как `"$PROJECT_ROOT/scripts/install.sh"` для обеспечения корректного пути в любом контексте

### 3. Передача PROJECT_ROOT при переключении на обычного пользователя

В следующих местах добавлена передача переменной `PROJECT_ROOT`:

### 4. Исправление проверки прав суперпользователя

- Добавлены исключения в проверку `check_sudo` для специальных категорий (`aur_with_desktop_choice`, `cosmic_aur_packages`), которые должны запускаться от обычного пользователя
- Это предотвращает ошибочное срабатывание проверки прав при внутренних вызовах скрипта от обычного пользователя

### 5. Улучшенная система очистки временных файлов

- Добавлена глобальная система отслеживания временных файлов с использованием массива `TEMP_FILES`
- Создана функция `add_temp_file()` для добавления временных файлов в список для очистки
- Реализована централизованная функция `cleanup_temp_files()` для удаления всех временных файлов
- Добавлены обработчики сигналов (SIGINT, SIGTERM) и выхода из скрипта (EXIT) для гарантированной очистки временных файлов при любом завершении работы скрипта
- Все места создания временных файлов обновлены для добавления их в систему отслеживания

- Строка 323: при установке AUR пакетов COSMIC
- Строка 373: при установке AUR пакетов с выбором рабочей среды
- Строка 700: при установке AUR пакетов в режиме `all_with_aur`

Пример изменения:
```bash
# Было:
sudo -u "$original_user" "$SCRIPT_ABSOLUTE_PATH" cosmic_aur_packages "$install_only_missing"

# Стало:
sudo -u "$original_user" PROJECT_ROOT="$PROJECT_ROOT" "$SCRIPT_ABSOLUTE_PATH" cosmic_aur_packages "$install_only_missing"
```

### 3. Обновление функций работы с файлами

Функции `install_from_file` и `install_from_file_content` обновлены для проверки файлов по абсолютному пути в `PROJECT_ROOT`, если они не найдены по относительному пути.

### 4. Обновление обработки файлов в фильтрации пакетов

Все места, где происходила работа с файлами проекта (например, при фильтрации AUR пакетов), обновлены для использования абсолютных путей через `PROJECT_ROOT`.

### 5. Улучшение определения оригинального пользователя

В строке 694 заменено `logname` на `logname 2>/dev/null || whoami` для лучшей совместимости.

## Результат

После внесения изменений команда `sudo ./install.sh all` корректно устанавливает как системные пакеты (от root), так и пакеты из AUR (от обычного пользователя), без ошибок доступа к файлам проекта.